"0","## define functions for this problem"
"0","## function to simulate data:"
"0","## ng groups, nr replicates (or individuals) per group, 1 observation / individual"
"0","## fsd = SD of group random effects, indsd = SD of individual random effects"
"0","## b = fixed effect coefficients, of size 2: intercept and slope"
"0","simfun = function(ng=4, nr=10, fsd=1, indsd=0.5, b=c(1,2)) {"
"0","  ntot = nr*ng"
"0","  b.reff = rnorm(ng, sd=fsd)"
"0","  b.rind = rnorm(ntot, sd=indsd)"
"0","  x = runif(ntot) # predictor"
"0","  dd = data.frame(x, f=factor(rep(LETTERS[1:ng], each=nr)), obs=factor(1:ntot))"
"0","  dd$eta0 = as.vector(model.matrix(~x,data=dd) %*% b)"
"0","  dd$bi = b.rind"
"0","  dd$eta = with(dd, eta0 + b.reff[f] + b.rind) # log E(Yi) = Xbeta + group RE + indiv RE bi"
"0","  dd$mu = exp(dd$eta)"
"0","  dd$y = with(dd, rpois(ntot, lambda=mu))"
"0","  dd"
"0","}"
"0","## function to extract the variance components and fixed effects"
"0","cfun = function(d) {"
"0","  m = glmer(y ~ x + (1|f) + (1|obs), family=""poisson"", data=d)"
"0","  c(sqrt(unlist(VarCorr(m))), fixef(m))"
"0","}"
"0","p3_plot <- function(df, title){"
"0","  ggplot(data = df, aes(x = x,y = y, color = f)) +"
"0","    geom_point() + "
"0","    geom_smooth(method = ""glm"", se = F) + "
"0","    ggtitle(title)"
"0","}"
